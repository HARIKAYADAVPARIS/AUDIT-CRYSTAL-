<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Audit Crystal | Global Standards Engine</title>
  <meta name="description" content="AI-powered CSRD, GRI, SASB & ISSB Audit Readiness Tool. Upload your sustainability report for instant gaps and scoring." />
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            audit: {
              50: '#fffbeb',
              100: '#fef3c7',
              200: '#fde68a',
              300: '#fcd34d',
              400: '#fbbf24',
              500: '#f59e0b', // Primary Gold
              600: '#d97706', // Dark Gold
              700: '#b45309',
              800: '#92400e',
              900: '#78350f',
              950: '#451a03',
            },
            sustain: { 500: '#10b981' },
            slate: {
              850: '#1e293b',
              900: '#0f172a',
              950: '#020617', // Deepest background
            }
          },
          fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
          animation: {
            'blob': 'blob 7s infinite',
            'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
            'fade-in': 'fadeIn 0.5s ease-out forwards',
          },
          keyframes: {
            blob: { '0%': { transform: 'translate(0px, 0px) scale(1)' }, '33%': { transform: 'translate(30px, -50px) scale(1.1)' }, '66%': { transform: 'translate(-20px, 20px) scale(0.9)' }, '100%': { transform: 'translate(0px, 0px) scale(1)' } },
            fadeInUp: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }
          }
        }
      }
    }
  </script>

  <!-- React & Babel -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style> 
    body { font-family: 'Inter', sans-serif; }
    .grid-bg {
        background-color: #020617; /* slate-950 */
        background-size: 40px 40px;
        background-image:
          linear-gradient(to right, rgba(255, 255, 255, 0.03) 1px, transparent 1px),
          linear-gradient(to bottom, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
    }
  </style>

  <!-- Import Map for Google GenAI -->
  <script type="importmap">
  {
    "imports": {
      "@google/genai": "https://esm.run/@google/genai"
    }
  }
  </script>
</head>
<body class="bg-slate-950 text-slate-100 antialiased selection:bg-audit-500 selection:text-white grid-bg min-h-screen">
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import { GoogleGenAI } from "@google/genai";

    // --- CONFIGURATION ---
    window.process = { env: { } };
    
    // âš ï¸ INSTRUCTIONS:
    // To publish without prompts, paste your NEW Google Gemini API Key below.
    // Get a key here: https://aistudio.google.com/app/apikey
    const PUBLIC_API_KEY = "AIzaSyD-_kiS2lk5lqdkkMxHWmpf00lAXkCxPBI"; 

    // --- TYPES & ENUMS ---
    const AppState = {
      IDLE: 'IDLE',
      ANALYZING: 'ANALYZING',
      COMPLETE: 'COMPLETE',
      ERROR: 'ERROR'
    };

    // --- SERVICES ---
    const generatePDF = (report) => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const pageWidth = doc.internal.pageSize.width;
      const pageHeight = doc.internal.pageSize.height;

      doc.setFillColor(2, 6, 23); // slate-950
      doc.rect(0, 0, pageWidth, 24, "F");
      
      // Logo text
      doc.setFontSize(18);
      doc.setFont("helvetica", "bold");
      doc.setTextColor(255, 255, 255);
      doc.text("AUDIT", 14, 16);
      doc.setTextColor(245, 158, 11); // audit-500 (Gold)
      doc.text("CRYSTAL", 35, 16);

      doc.setTextColor(148, 163, 184); // slate-400
      doc.setFontSize(10);
      doc.setFont("helvetica", "normal");
      doc.text("Global Standards Engine", pageWidth - 14, 16, { align: "right" });

      let y = 40;
      doc.setTextColor(15, 23, 42);
      doc.setFontSize(24);
      doc.setFont("helvetica", "bold");
      doc.text("Audit Readiness Report", 14, y);
      y += 10;
      doc.setFontSize(12);
      doc.setFont("helvetica", "normal");
      doc.setTextColor(71, 85, 105);
      doc.text(`Document: ${report.documentTitle}`, 14, y);
      y += 6;
      doc.text(`Date: ${new Date().toLocaleDateString()}`, 14, y);
      y += 6;
      doc.text(`Sector: ${report.sectorGuess} | Region: ${report.jurisdictionGuess}`, 14, y);
      y += 15;

      if (report.executiveSummary) {
        doc.setFontSize(14); doc.setTextColor(15, 23, 42); doc.setFont("helvetica", "bold");
        doc.text("Executive Summary", 14, y); y += 6;
        doc.setFontSize(10); doc.setTextColor(51, 65, 85); doc.setFont("helvetica", "normal");
        const splitSum = doc.splitTextToSize(report.executiveSummary, pageWidth - 28);
        doc.text(splitSum, 14, y); y += (splitSum.length * 5) + 10;
      }

      doc.setDrawColor(226, 232, 240);
      doc.setFillColor(248, 250, 252);
      doc.roundedRect(14, y, pageWidth - 28, 30, 3, 3, "FD");
      doc.setTextColor(15, 23, 42);
      doc.setFontSize(14);
      doc.setFont("helvetica", "bold");
      doc.text("Global Composite Score", 20, y + 12);
      const score = report.globalCompositeScore;
      doc.setFontSize(32);
      if (score > 75) doc.setTextColor(22, 163, 74);
      else if (score > 40) doc.setTextColor(245, 158, 11); // Gold
      else doc.setTextColor(220, 38, 38);
      doc.text(`${score}/100`, pageWidth - 25, y + 20, { align: "right" });
      y += 45;

      doc.setFontSize(14);
      doc.setTextColor(15, 23, 42);
      doc.setFont("helvetica", "bold");
      doc.text("Framework Evaluation", 14, y);
      y += 5;

      const tableData = report.standardsEvaluations.map(std => [
        std.standardKey.replace(/_/g, " "),
        std.maturityLabel,
        `${std.overallScore}%`,
        std.summary
      ]);

      doc.autoTable({
        startY: y,
        head: [["Framework", "Maturity", "Score", "Summary"]],
        body: tableData,
        theme: 'grid',
        headStyles: { fillColor: [15, 23, 42], textColor: 255, fontStyle: 'bold' },
        styles: { fontSize: 9, cellPadding: 4 },
        columnStyles: { 0: { fontStyle: 'bold', cellWidth: 40 }, 3: { cellWidth: 'auto' } }
      });
      y = doc.lastAutoTable.finalY + 15;

      // -- NEW: CFO RISK TABLE --
      const highRiskTopics = report.standardsEvaluations.flatMap(std => 
        std.topics.filter(t => t.financialRisk === 'High' || t.financialRisk === 'Critical')
      );

      if (highRiskTopics.length > 0) {
        if (y > pageHeight - 50) { doc.addPage(); y = 30; }
        doc.setFontSize(14);
        doc.setTextColor(185, 28, 28); // red-700
        doc.text("Critical Gaps & Financial Impact", 14, y);
        y += 8;

        const riskData = highRiskTopics.map(t => [
          t.topicId,
          t.financialRisk || 'Unknown',
          t.implementationCost || 'Unknown',
          t.recommendations[0] || 'See report'
        ]);

        doc.autoTable({
          startY: y,
          head: [["Gap / Topic", "Fin. Risk", "Impl. Cost", "Recommendation"]],
          body: riskData,
          theme: 'striped',
          headStyles: { fillColor: [185, 28, 28], textColor: 255, fontStyle: 'bold' },
          styles: { fontSize: 8, cellPadding: 3 },
          columnStyles: { 0: { cellWidth: 40, fontStyle: 'bold' }, 1: { cellWidth: 20 }, 2: { cellWidth: 20 } }
        });
        y = doc.lastAutoTable.finalY + 15;
      }

      if (y > pageHeight - 50) { doc.addPage(); y = 30; }
      doc.setFontSize(14);
      doc.setTextColor(15, 23, 42);
      doc.text("Strategic Roadmap", 14, y);
      y += 8;
      doc.setFontSize(10);
      doc.setTextColor(51, 65, 85);
      doc.setFont("helvetica", "normal");
      report.globalRecommendations.forEach((rec) => {
        if (y > pageHeight - 20) { doc.addPage(); y = 30; }
        const splitRec = doc.splitTextToSize(`â€¢ ${rec}`, pageWidth - 30);
        doc.text(splitRec, 14, y);
        y += (splitRec.length * 5) + 2;
      });

      doc.save("Audit_Crystal_Report.pdf");
    };

    const analyzeCSRDReadiness = async (content, apiKeyOverride) => {
      const apiKey = apiKeyOverride || window.process.env.API_KEY || PUBLIC_API_KEY;
      if (!apiKey) throw new Error("API Key is missing or invalid.");
      const ai = new GoogleGenAI({ apiKey });
      const systemInstruction = `
        You are **Audit Crystal**, an advanced AI Sustainability Assurance Engine designed for CFOs and External Auditors.
    
        **YOUR KNOWLEDGE BASE:**
        Apply deep forensic knowledge of: CSRD (ESRS 1, 2, E1-E5, S1-S4), GRI (Universal Standards), ISSB (IFRS S1 & S2), SASB, TCFD, and EU Taxonomy.

        **CFO INTELLIGENCE LAYER:**
        For every finding, you MUST estimate:
        1.  **Financial Risk:** If this gap remains, what is the risk to enterprise value, fines, or access to capital? (Low/Medium/High/Critical). *Critical* = Potential regulatory fine or loss of key investors.
        2.  **Implementation Cost:** How expensive/complex is it to fix this gap? (Low/Medium/High). *High* = Requires new software, hiring consultants, or multi-year data collection.

        **TASKS:**
        1.  **Forensic Scan:** Analyze the document for *hard evidence* (tables, specific year-on-year data, citations of standards).
        2.  **No Hallucinations:** If data is missing, state "Data Not Disclosed". Do not invent numbers.
        3.  **CFO Persona:** Use professional, concise, risk-oriented language. Avoid "Cheerleading". Focus on compliance gaps.

        Output valid JSON.
      `;

      const parts = [];
      if (content.text) parts.push({ text: `DOCUMENT START\n${content.text}\nDOCUMENT END` });
      if (content.file) parts.push({ inlineData: { mimeType: content.file.mimeType, data: content.file.base64 } });

      const response = await ai.models.generateContent({
        model: "gemini-2.5-flash",
        contents: { parts },
        config: {
          systemInstruction,
          thinkingConfig: { thinkingBudget: 0 },
          temperature: 0,
          responseMimeType: "application/json",
          responseSchema: {
            type: "OBJECT",
            properties: {
              documentTitle: { type: "STRING" },
              sectorGuess: { type: "STRING" },
              jurisdictionGuess: { type: "STRING" },
              executiveSummary: { type: "STRING" },
              globalCompositeScore: { type: "INTEGER" },
              keyGaps: { type: "ARRAY", items: { type: "STRING" } },
              globalRecommendations: { type: "ARRAY", items: { type: "STRING" } },
              standardsEvaluations: {
                type: "ARRAY",
                items: {
                  type: "OBJECT",
                  properties: {
                    standardKey: { type: "STRING" },
                    overallScore: { type: "INTEGER" },
                    maturityLabel: { type: "STRING" },
                    summary: { type: "STRING" },
                    topics: {
                      type: "ARRAY",
                      items: {
                        type: "OBJECT",
                        properties: {
                          topicId: { type: "STRING" },
                          score: { type: "INTEGER" },
                          coverageLevel: { type: "STRING" },
                          reasoning: { type: "STRING" },
                          evidenceSnippets: { type: "ARRAY", items: { type: "STRING" } },
                          recommendations: { type: "ARRAY", items: { type: "STRING" } },
                          remediationType: { type: "STRING" },
                          financialRisk: { type: "STRING", enum: ["Low", "Medium", "High", "Critical"] },
                          implementationCost: { type: "STRING", enum: ["Low", "Medium", "High"] }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      });
      return JSON.parse(response.text);
    };

    const generateDraftFix = async (gap, sector, apiKeyOverride) => {
       const apiKey = apiKeyOverride || window.process.env.API_KEY || PUBLIC_API_KEY;
       const ai = new GoogleGenAI({ apiKey });
       const prompt = `You are a Senior ESG Reporting Consultant. CONTEXT: Gap Identified: "${gap}", Sector: "${sector}". TASK: Generate a compliant draft disclosure (approx 100 words) to close this gap.`;
       const res = await ai.models.generateContent({ model: "gemini-2.5-flash", contents: prompt });
       return res.text;
    };

    // --- COMPONENTS ---

    const Navbar = () => (
      <header className="sticky top-0 z-40 bg-slate-950/80 backdrop-blur-md border-b border-slate-800 shadow-sm">
        <div className="container mx-auto px-4 h-20 flex justify-between items-center">
          <div className="flex items-center gap-3">
             <img src="/logo.png" alt="Audit Crystal Logo" className="h-12 w-auto object-contain select-none" onError={(e) => { e.currentTarget.style.display = 'none'; e.currentTarget.parentElement.classList.add('text-audit-500'); }} />
             <span className="font-bold text-xl tracking-tight text-white">
                AUDIT <span className="text-audit-500">CRYSTAL</span>
             </span>
          </div>
          <nav className="hidden md:flex items-center gap-8 text-sm font-medium text-slate-400">
            <a href="#upload-section" className="hover:text-audit-400 transition-colors">Scan</a>
            <a href="#pricing" className="hover:text-audit-400 transition-colors">Pricing</a>
            <a href="#contact" className="hover:text-audit-400 text-audit-500">Book Demo</a>
          </nav>
          <button onClick={() => document.getElementById("upload-section")?.scrollIntoView({ behavior: "smooth" })} className="px-5 py-2.5 rounded-lg bg-gradient-to-r from-audit-600 to-audit-500 text-white text-sm font-bold hover:from-audit-500 hover:to-audit-400 transition shadow-lg shadow-audit-900/20">Start Free Scan</button>
        </div>
      </header>
    );

    const ApiKeyModal = ({ isOpen, onSave }) => {
      const [inputKey, setInputKey] = React.useState('');
      if (!isOpen) return null;
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/90 backdrop-blur-sm">
          <div className="bg-slate-800 rounded-2xl p-8 max-w-md w-full border border-slate-700 shadow-2xl animate-fade-in-up">
            <h3 className="text-xl font-bold text-white mb-2 text-center">Configure API Key</h3>
            <p className="text-sm text-slate-400 mb-6 text-center">
              The previously configured API Key was revoked by Google for safety. Please enter a new key to continue.
            </p>
            <input 
              type="password" 
              value={inputKey} 
              onChange={(e) => setInputKey(e.target.value)}
              placeholder="Paste your Gemini API Key here..."
              className="w-full bg-slate-950 border border-slate-700 rounded-lg px-4 py-3 text-white mb-4 focus:ring-2 focus:ring-audit-500 outline-none transition-all"
            />
            <button 
              onClick={() => onSave(inputKey)}
              disabled={!inputKey}
              className="w-full py-3 bg-gradient-to-r from-audit-600 to-audit-500 text-white font-bold rounded-lg hover:from-audit-500 hover:to-audit-400 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-lg shadow-audit-900/20"
            >
              Save & Continue
            </button>
            <div className="mt-4 text-center">
              <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" className="text-xs text-audit-500 hover:text-audit-400 underline">Generate a new free key here</a>
            </div>
            <p className="text-[10px] text-slate-600 text-center mt-4">
              To skip this screen: Edit this file and paste your key into the <code>PUBLIC_API_KEY</code> variable.
            </p>
          </div>
        </div>
      );
    };

    const LegalModal = ({ isOpen, onClose, type }) => {
      if (!isOpen) return null;
      React.useEffect(() => { document.body.style.overflow = 'hidden'; return () => { document.body.style.overflow = 'unset'; } }, []);
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/50 backdrop-blur-sm">
          <div className="relative bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col z-10">
            <div className="flex justify-between items-center p-6 border-b border-slate-100">
              <h2 className="text-xl font-bold text-slate-900">{type === 'privacy' ? 'Privacy Policy' : 'Terms'}</h2>
              <button onClick={onClose} className="text-slate-500 hover:text-slate-800">âœ•</button>
            </div>
            <div className="p-6 overflow-y-auto text-sm text-slate-600">
              <p>This is a demo legal modal. Data is processed in-memory and not stored.</p>
            </div>
            <div className="p-6 border-t border-slate-100 bg-slate-50 rounded-b-2xl flex justify-end">
              <button onClick={onClose} className="px-6 py-2 bg-slate-900 text-white font-semibold rounded-lg hover:bg-slate-800 transition-colors">Close</button>
            </div>
          </div>
        </div>
      );
    };

    const UploadSection = ({ onAnalyze, onDemoLoad, isAnalyzing }) => {
      const [text, setText] = React.useState('');
      const [file, setFile] = React.useState(null);
      const [dragActive, setDragActive] = React.useState(false);

      const handleDrag = React.useCallback((e) => {
        e.preventDefault(); e.stopPropagation();
        if (e.type === "dragenter" || e.type === "dragover") setDragActive(true);
        else if (e.type === "dragleave") setDragActive(false);
      }, []);

      const processFile = (selectedFile) => {
        if(selectedFile.size > 20 * 1024 * 1024) { alert("File is too large. Max 20MB."); return; }
        const reader = new FileReader();
        reader.onload = (ev) => setFile({ name: selectedFile.name, mimeType: selectedFile.type, base64: ev.target.result.split(',')[1] });
        reader.readAsDataURL(selectedFile);
      };

      const handleDrop = React.useCallback((e) => {
        e.preventDefault(); e.stopPropagation(); setDragActive(false);
        if (e.dataTransfer.files?.[0]) processFile(e.dataTransfer.files[0]);
      }, []);

      const handleFile = (e) => {
        const f = e.target.files?.[0];
        if (f) processFile(f);
      };

      return (
        <div className="w-full max-w-4xl mx-auto space-y-6 animate-fade-in-up">
           <div id="upload-area" className="bg-slate-900 rounded-3xl shadow-2xl border border-slate-800 overflow-hidden">
             {/* Security Banner */}
             <div className="bg-slate-950/50 border-b border-slate-800 px-6 py-2 flex justify-between items-center text-[10px] text-slate-500 font-mono">
               <div className="flex items-center gap-2"><span className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>SECURE UPLOAD GATEWAY</div>
               <div>TLS 1.3 ENCRYPTED</div>
             </div>
             <div className="grid grid-cols-1 md:grid-cols-2 gap-0 md:divide-x divide-slate-800">
               <div 
                 className={`relative p-10 flex flex-col items-center justify-center text-center transition-all duration-200 min-h-[300px] 
                   ${dragActive ? 'bg-slate-800/80 border-2 border-dashed border-audit-500 scale-[1.02] shadow-xl z-50' : 'bg-slate-900 hover:bg-slate-800/50'}`}
                 onDragEnter={handleDrag} onDragLeave={handleDrag} onDragOver={handleDrag} onDrop={handleDrop}
               >
                  <input type="file" accept=".pdf,.txt,.md,.csv" onChange={handleFile} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-20" disabled={isAnalyzing} />
                  {dragActive && <div className="absolute inset-0 bg-slate-900/90 flex items-center justify-center z-10 pointer-events-none backdrop-blur-sm"><p className="text-xl font-bold text-audit-400 animate-pulse">Drop to Analyze</p></div>}
                  <div className="w-16 h-16 bg-slate-800 text-audit-500 rounded-2xl flex items-center justify-center mb-6 border border-slate-700">ðŸ“„</div>
                  {file ? (
                    <div className="space-y-2 z-20 relative bg-slate-800 px-6 py-3 rounded-xl shadow-sm border border-slate-700">
                      <p className="font-bold text-slate-200">{file.name}</p>
                      <button onClick={(e) => { e.preventDefault(); setFile(null); }} className="text-xs text-red-400 bg-red-900/20 px-3 py-1 rounded-full border border-red-900/30">Remove</button>
                    </div>
                  ) : (
                    <>
                      <p className="text-xl font-bold text-slate-100 mb-2">Drop PDF here</p>
                      <p className="text-slate-400">Supports PDF, TXT (Max 20MB)</p>
                    </>
                  )}
               </div>
               <div className="p-8 bg-slate-800/30 flex flex-col">
                  <textarea value={text} onChange={e => setText(e.target.value)} placeholder="Or paste text..." className="flex-1 w-full p-4 rounded-xl border border-slate-700 bg-slate-800 text-slate-200 resize-none text-sm placeholder-slate-500 focus:ring-2 focus:ring-audit-500" rows={5} disabled={isAnalyzing}></textarea>
               </div>
             </div>
             <div className="bg-slate-900 p-6 border-t border-slate-800 flex items-center justify-between">
                <button onClick={onDemoLoad} className="text-sm text-slate-500 hover:text-audit-400 font-medium flex items-center gap-1"><svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg> View Demo Report</button>
                <button onClick={() => onAnalyze(file, text)} disabled={(!file && !text) || isAnalyzing} className={`px-8 py-3 rounded-xl font-bold text-white transition-all ${(!file && !text) || isAnalyzing ? 'bg-slate-800 text-slate-600' : 'bg-gradient-to-r from-audit-600 to-audit-500 hover:from-audit-500 hover:to-audit-400 shadow-xl'}`}>
                  {isAnalyzing ? 'Processing...' : 'Run Analysis'}
                </button>
             </div>
           </div>
        </div>
      );
    };

    const ScoreRing = ({ score, size = 'lg' }) => {
      const r = size === 'lg' ? 36 : 20;
      const dim = size === 'lg' ? 96 : 48;
      const circ = 2 * Math.PI * r;
      const offset = circ - (score / 100) * circ;
      const color = score > 80 ? '#10b981' : score > 50 ? '#f59e0b' : '#ef4444';
      return (
        <div className={`relative flex items-center justify-center ${size === 'lg' ? 'w-24 h-24' : 'w-12 h-12'}`}>
          <svg className="w-full h-full transform -rotate-90">
            <circle cx={dim/2} cy={dim/2} r={r} stroke="#1e293b" strokeWidth={size==='lg'?8:4} fill="transparent" />
            <circle cx={dim/2} cy={dim/2} r={r} stroke={color} strokeWidth={size==='lg'?8:4} fill="transparent" strokeDasharray={circ} strokeDashoffset={offset} strokeLinecap="round" />
          </svg>
          <span className={`absolute font-bold text-white ${size==='lg'?'text-2xl':'text-xs'}`}>{score}</span>
        </div>
      );
    };

    const ReportView = ({ report, onReset, apiKey }) => {
      const [selKey, setSelKey] = React.useState(report.standardsEvaluations[0]?.standardKey);
      const [fixDraft, setFixDraft] = React.useState(null);
      const [loadingFix, setLoadingFix] = React.useState(false);
      const selected = report.standardsEvaluations.find(s => s.standardKey === selKey);

      const handleFix = async (rec, sector) => {
        setLoadingFix(true);
        try { const text = await generateDraftFix(rec, sector, apiKey); setFixDraft(text); } catch(e) { setFixDraft("Error generating fix."); }
        setLoadingFix(false);
      };

      return (
        <div className="max-w-6xl mx-auto space-y-6 pb-12 animate-fade-in">
          {/* Header & Score */}
          <div className="bg-slate-900 rounded-2xl p-6 shadow-xl border border-slate-700 flex flex-wrap gap-6 items-center justify-between">
            <div className="flex items-center gap-4">
               <div className="h-12 w-12 flex items-center justify-center text-audit-600"><img src="/logo.png" className="h-10 w-auto" onError={(e)=>e.target.style.display='none'} /></div>
               <div><h1 className="text-2xl font-bold text-white">{report.documentTitle || 'Audit Report'}</h1><p className="text-sm text-slate-400">{report.sectorGuess} â€¢ {report.jurisdictionGuess}</p></div>
            </div>
            <div className="flex items-center gap-6">
               <div className="text-right"><p className="text-xs font-bold text-slate-500 uppercase">Score</p><ScoreRing score={report.globalCompositeScore} /></div>
               <div className="flex flex-col gap-2"><button onClick={() => generatePDF(report)} className="px-4 py-2 bg-slate-100 text-slate-900 text-sm font-bold rounded-lg hover:bg-white">Download PDF</button><button onClick={onReset} className="text-xs text-slate-400 hover:text-white text-right">New Scan</button></div>
            </div>
          </div>

          {/* Executive Summary */}
          {report.executiveSummary && <div className="bg-gradient-to-r from-slate-900 to-slate-950 rounded-2xl p-6 text-white shadow-lg border border-slate-800"><h3 className="font-bold text-lg mb-2 text-audit-500">Executive Auditor Opinion</h3><p className="text-slate-300 text-sm leading-relaxed">{report.executiveSummary}</p></div>}
          
          <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div className="lg:col-span-4 space-y-3">
               {report.standardsEvaluations.map(std => (
                 <div key={std.standardKey} onClick={() => setSelKey(std.standardKey)} className={`p-4 rounded-xl border cursor-pointer transition-all ${std.standardKey === selKey ? 'bg-audit-900/20 border-audit-600/50' : 'bg-slate-900 border-slate-800 hover:bg-slate-800'}`}>
                    <div className="flex justify-between items-center mb-1"><span className={`font-bold text-sm ${std.standardKey === selKey ? 'text-audit-400' : 'text-slate-300'}`}>{std.standardKey.replace(/_/g, ' ')}</span><span className={`text-xs font-bold px-2 py-0.5 rounded ${std.overallScore > 80 ? 'bg-emerald-900/30 text-emerald-400' : std.overallScore > 50 ? 'bg-audit-900/30 text-audit-400' : 'bg-red-900/30 text-red-400'}`}>{std.maturityLabel}</span></div>
                    <div className="flex items-center gap-2"><ScoreRing score={std.overallScore} size="sm" /><span className="text-xs text-slate-500 line-clamp-1">{std.summary}</span></div>
                 </div>
               ))}
            </div>
            <div className="lg:col-span-8 space-y-6">
              {selected && (
                <div className="bg-slate-900 rounded-2xl border border-slate-800 overflow-hidden shadow-lg">
                   <div className="p-6 bg-slate-950/30 border-b border-slate-800"><h2 className="text-xl font-bold text-white">{selected.standardKey.replace(/_/g, ' ')} Analysis</h2><p className="text-sm text-slate-400 mt-1">{selected.summary}</p></div>
                   <div className="divide-y divide-slate-800">
                      {selected.topics.map((t, i) => (
                        <div key={i} className="p-4 hover:bg-slate-800/50 group transition-colors">
                           <div className="flex justify-between items-center mb-2">
                              <span className="font-bold text-sm text-slate-200">{t.topicId}</span>
                              <div className="flex items-center gap-2">
                                {/* Risk Badge */}
                                {(t.financialRisk === 'High' || t.financialRisk === 'Critical') && (
                                  <span className="text-[10px] text-red-500 font-bold bg-red-900/20 px-1 rounded border border-red-900/30">$ RISK</span>
                                )}
                                <span className={`w-2 h-2 rounded-full ${t.coverageLevel==='full'?'bg-emerald-500':t.coverageLevel==='partial'?'bg-audit-500':'bg-red-500'}`}></span>
                                <span className={`font-bold text-sm ${t.score > 80 ? 'text-emerald-500' : t.score > 50 ? 'text-audit-500' : 'text-red-500'}`}>{t.score}/100</span>
                              </div>
                           </div>
                           
                           {/* CFO Impact Assessment */}
                           <div className="bg-slate-800/50 rounded-lg p-3 border border-slate-700 mb-3">
                              <h4 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 flex items-center gap-2">CFO Impact</h4>
                              <div className="grid grid-cols-2 gap-4">
                                 <div>
                                    <p className="text-[10px] text-slate-500 uppercase mb-1">Financial Risk</p>
                                    <div className="flex items-center gap-2">
                                       <div className={`w-2 h-2 rounded-full ${t.financialRisk === 'Critical' ? 'bg-red-600 animate-pulse' : t.financialRisk === 'High' ? 'bg-red-500' : 'bg-emerald-500'}`}></div>
                                       <span className={`text-xs font-bold ${t.financialRisk === 'Critical' || t.financialRisk === 'High' ? 'text-white' : 'text-slate-300'}`}>{t.financialRisk || 'N/A'}</span>
                                    </div>
                                 </div>
                                 <div className="border-l border-slate-700 pl-4">
                                    <p className="text-[10px] text-slate-500 uppercase mb-1">Impl. Cost</p>
                                    <span className="text-xs font-bold text-slate-300">{t.implementationCost || 'N/A'}</span>
                                 </div>
                              </div>
                           </div>

                           <p className="text-xs text-slate-400 mb-2">{t.reasoning}</p>
                           {t.recommendations?.length > 0 && (
                             <div className="flex justify-between items-center bg-slate-800/50 p-2 rounded border border-slate-700">
                               <span className="text-xs text-slate-300">â†’ {t.recommendations[0]}</span>
                               {t.coverageLevel !== 'full' && (
                                 <button onClick={(e) => { e.stopPropagation(); handleFix(t.recommendations[0], report.sectorGuess); }} className="text-[10px] bg-white text-slate-900 px-2 py-1 rounded font-bold hover:bg-slate-200 ml-2">Draft Fix</button>
                               )}
                             </div>
                           )}
                        </div>
                      ))}
                   </div>
                </div>
              )}
            </div>
          </div>
          {fixDraft && <div className="fixed inset-0 z-50 flex items-center justify-center p-4"><div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={() => setFixDraft(null)}></div><div className="relative bg-slate-800 rounded-xl p-6 max-w-lg w-full z-10 border border-slate-700 shadow-2xl"><h3 className="font-bold text-lg mb-2 text-white">AI Draft Disclosure</h3><div className="bg-slate-900 p-4 rounded border border-slate-700 text-sm text-slate-300 mb-4 whitespace-pre-wrap font-mono">{fixDraft}</div><button onClick={() => { navigator.clipboard.writeText(fixDraft); setFixDraft(null); }} className="w-full py-2 bg-audit-600 text-white rounded font-bold hover:bg-audit-500">Copy & Close</button></div></div>}
        </div>
      );
    };

    const PricingSection = () => (
      <div id="pricing" className="py-20 px-4 text-center">
        <h2 className="text-3xl font-bold text-white mb-12">Audit Pricing</h2>
        <div className="grid md:grid-cols-3 gap-8 max-w-6xl mx-auto">
           <div className="bg-slate-900 p-8 rounded-2xl border border-slate-800 shadow-sm"><h3 className="font-bold text-xl text-white">Scan</h3><p className="text-4xl font-bold my-4 text-white">Free</p><p className="text-sm text-slate-400 mb-6">For instant checks</p><button className="w-full py-2 bg-slate-800 text-slate-300 rounded-lg font-bold">Current</button></div>
           <div className="bg-slate-800 p-8 rounded-2xl border border-audit-500 shadow-xl transform md:-translate-y-4 relative"><div className="absolute top-0 right-0 bg-audit-500 text-white text-xs font-bold px-2 py-1 rounded-bl">POPULAR</div><h3 className="font-bold text-xl text-white">Deep Audit</h3><p className="text-4xl font-bold my-4 text-white">$499</p><p className="text-sm text-slate-400 mb-6">For consultants</p><button className="w-full py-2 bg-audit-600 text-white rounded-lg font-bold hover:bg-audit-500">Book Audit</button></div>
           <div className="bg-slate-900 p-8 rounded-2xl border border-slate-800 shadow-sm"><h3 className="font-bold text-xl text-white">Enterprise</h3><p className="text-4xl font-bold my-4 text-white">Custom</p><p className="text-sm text-slate-400 mb-6">Human verification</p><button className="w-full py-2 border-2 border-slate-700 text-white rounded-lg font-bold hover:bg-slate-800">Contact</button></div>
        </div>
      </div>
    );

    const ContactSection = () => (
      <section id="contact" className="py-24 bg-gradient-to-br from-slate-900 to-slate-950 text-white">
        <div className="max-w-3xl mx-auto px-6 text-center mb-14 animate-fade-in-up">
          <h2 className="text-4xl font-extrabold mb-4 tracking-tight">Join Pilot Program</h2>
          <p className="text-slate-300 text-lg leading-relaxed">Get 3 complimentary Deep Audits.</p>
        </div>
        <div className="max-w-3xl mx-auto px-6 animate-fade-in"><div className="relative w-full shadow-2xl rounded-2xl overflow-hidden ring-1 ring-white/10 bg-slate-800"><div style={{ padding: '40px', textAlign: 'center' }}><p>Demo Form Placeholder</p></div></div></div>
      </section>
    );

    const WhySection = () => (
      <div className="py-20 text-center bg-slate-950">
         <h2 className="text-3xl font-bold text-white mb-12">How it Works</h2>
         <div className="grid md:grid-cols-3 gap-8 max-w-6xl mx-auto px-4">
            <div className="p-6 bg-slate-900 border border-slate-800 rounded-2xl shadow-sm"><div className="text-4xl mb-4">ðŸ“„</div><h3 className="font-bold text-white">1. Upload Report</h3><p className="text-sm text-slate-400 mt-2">Drag & drop your PDF or text.</p></div>
            <div className="p-6 bg-slate-900 border border-slate-800 rounded-2xl shadow-sm"><div className="text-4xl mb-4">ðŸ§ </div><h3 className="font-bold text-white">2. AI Analysis</h3><p className="text-sm text-slate-400 mt-2">Gemini maps against 9 frameworks.</p></div>
            <div className="p-6 bg-slate-900 border border-slate-800 rounded-2xl shadow-sm"><div className="text-4xl mb-4">ðŸ“Š</div><h3 className="font-bold text-white">3. Get Roadmap</h3><p className="text-sm text-slate-400 mt-2">See gaps and download PDF.</p></div>
         </div>
      </div>
    );

    // --- MAIN APP ---
    const App = () => {
      const [state, setState] = React.useState(AppState.IDLE);
      const [report, setReport] = React.useState(null);
      const [error, setError] = React.useState(null);
      const [legal, setLegal] = React.useState({ open: false, type: 'privacy' });
      const [userKey, setUserKey] = React.useState('');
      const [showKeyModal, setShowKeyModal] = React.useState(false);

      const handleAnalyze = async (file, text) => {
        // 1. Check if we have a valid key (Hardcoded OR User-entered)
        const activeKey = PUBLIC_API_KEY || userKey;
        
        if (!activeKey) {
          setShowKeyModal(true);
          return;
        }

        setState(AppState.ANALYZING); setError(null);
        try { 
            // Pass the activeKey to the service
            const res = await analyzeCSRDReadiness({ file, text }, activeKey); 
            setReport(res); 
            setState(AppState.COMPLETE); 
        } 
        catch (e) { 
            console.error(e); 
            // If the error suggests the key is invalid (e.g. 403), show modal again
            if (e.message.includes("403") || e.message.includes("API key") || e.message.includes("PERMISSION_DENIED")) {
                setError("API Key Invalid or Leaked. Please enter a new one.");
                setShowKeyModal(true);
                setState(AppState.IDLE);
            } else {
                setError(e.message || "Analysis failed."); 
                setState(AppState.ERROR); 
            }
        }
      };

      const handleKeySave = (key) => {
        setUserKey(key);
        setShowKeyModal(false);
      };

      const handleDemoLoad = () => {
        setState(AppState.ANALYZING);
        setError(null);
        setTimeout(() => {
          const demoData = {
            documentTitle: "Nordic Manufacturing Group 2024",
            sectorGuess: "Industrial Manufacturing",
            jurisdictionGuess: "European Union (CSRD In-Scope)",
            executiveSummary: "The report demonstrates strong foundational compliance with GRI standards but exhibits material gaps in CSRD/ESRS readiness, particularly regarding the 'Double Materiality' process and Scope 3 GHG accounting. While governance structures (G) are mature, quantitative targets for biodiversity (E4) and circular economy (E5) lack the granularity required by the Taxonomy Regulation. Financial materiality (ISSB S1) is well-articulated, but climate scenario analysis (TCFD) is limited to a single 2Â°C pathway.",
            globalCompositeScore: 68,
            auditId: "DEMO-X92",
            timestamp: new Date().toISOString(),
            keyGaps: [
              "ESRS 1: Double Materiality methodology not fully disclosed.",
              "ESRS E1-6: Scope 3 GHG emissions exclude 'Use of Sold Products'.",
              "EU Taxonomy: CapEx alignment methodology missing.",
              "TCFD: Physical risk analysis lacks financial impact modeling."
            ],
            globalRecommendations: [
              "Formalize the Double Materiality stakeholder engagement process (ESRS 1).",
              "Conduct a full Scope 3 screening to identify material categories beyond supply chain.",
              "Integrate TCFD scenario analysis into financial planning for >4Â°C outcomes.",
              "Align Biodiversity targets with TNFD framework to satisfy ESRS E4 requirements."
            ],
            standardsEvaluations: [
              {
                standardKey: "CSRD_ESRS",
                overallScore: 62,
                maturityLabel: "Maturing",
                summary: "Partial alignment. General disclosures (ESRS 2) are strong, but environmental specifics (E1-E5) need data rigor.",
                topics: [
                   { 
                     topicId: "ESRS E1 Climate Change", 
                     score: 75, 
                     coverageLevel: "partial",
                     reasoning: "Scope 1 & 2 data is audit-ready. Scope 3 is incomplete. Transition plan is high-level.",
                     evidenceSnippets: ["Scope 1: 45,000 tCO2e", "Scope 2 (Market-based): 12,000 tCO2e", "We are developing a roadmap for Scope 3."],
                     recommendations: ["Calculate Scope 3 Cat 11 (Use of Sold Products).", "Publish a quantified Transition Plan aligned with 1.5Â°C."],
                     remediationType: "DATA_TABLE",
                     financialRisk: "Critical",
                     implementationCost: "High"
                   },
                   { 
                     topicId: "ESRS S1 Own Workforce", 
                     score: 88, 
                     coverageLevel: "full",
                     reasoning: "Excellent disclosure of gender pay gap, injury rates, and collective bargaining coverage.",
                     evidenceSnippets: ["Gender Pay Gap: 2.1%", "LTIFR: 0.5", "Collective Bargaining: 94% coverage"],
                     recommendations: ["Maintain current reporting standard."],
                     remediationType: "NARRATIVE",
                     financialRisk: "Low",
                     implementationCost: "Low"
                   }
                ]
              },
              {
                standardKey: "ISSB",
                overallScore: 78,
                maturityLabel: "Advanced",
                summary: "Strong connection between sustainability risks and enterprise value (IFRS S1).",
                topics: [
                  {
                    topicId: "IFRS S2 Climate Resilience",
                    score: 70,
                    coverageLevel: "partial",
                    reasoning: "Financial impact of climate transition risks is quantified, but physical risks are qualitative.",
                    evidenceSnippets: ["Estimated carbon tax impact: â‚¬2.5M annually by 2030."],
                    recommendations: ["Quantify asset value at risk from physical climate events (floods, heat)."],
                    remediationType: "DATA_TABLE",
                    financialRisk: "High",
                    implementationCost: "Medium"
                  }
                ]
              },
              {
                standardKey: "EU_TAXONOMY",
                overallScore: 45,
                maturityLabel: "Emerging",
                summary: "Eligibility is reported, but Alignment criteria (Do No Significant Harm) documentation is missing.",
                topics: [
                  {
                    topicId: "Taxonomy Alignment",
                    score: 45,
                    coverageLevel: "partial",
                    reasoning: "Turnover eligibility reported (85%). Alignment assessment for DNSH is anecdotal.",
                    evidenceSnippets: ["85% of turnover is Taxonomy-eligible."],
                    recommendations: ["Conduct and document DNSH screening for all eligible activities."],
                    remediationType: "POLICY",
                    financialRisk: "Medium",
                    implementationCost: "High"
                  }
                ]
              }
            ]
          };
          setReport(demoData);
          setState(AppState.COMPLETE);
        }, 2500);
      };

      const reset = () => { setState(AppState.IDLE); setReport(null); setError(null); };

      return (
        <div className="min-h-screen flex flex-col">
          <div className="bg-gradient-to-r from-audit-600 to-audit-500 text-white text-xs font-bold py-2 text-center cursor-pointer" onClick={() => document.getElementById('contact')?.scrollIntoView()}>Join Pilot Program â€” Get 3 Free Deep Audits â†’</div>
          <Navbar />
          <ApiKeyModal isOpen={showKeyModal} onSave={handleKeySave} />
          <LegalModal isOpen={legal.open} onClose={() => setLegal({ ...legal, open: false })} type={legal.type} />
          
          <main className="flex-grow relative z-10">
            {state === AppState.IDLE && (
              <div className="pt-20 pb-12">
                 <div className="container mx-auto px-4 text-center max-w-5xl mb-16">
                    <div className="inline-block px-3 py-1 rounded-full bg-audit-600/10 text-audit-500 text-xs font-bold mb-8 border border-audit-600/20 shadow-sm tracking-wider uppercase">AI-Powered Assurance Engine</div>
                    <h1 className="text-5xl md:text-6xl font-extrabold text-white mb-6 tracking-tight leading-tight">Instant CSRD Gap Report for European SMEs â€” <span className="text-transparent bg-clip-text bg-gradient-to-r from-audit-500 to-audit-200">Powered by Gemini</span></h1>
                    <p className="text-2xl text-slate-400 mb-10 font-medium max-w-2xl mx-auto leading-relaxed">Your automated CSRD readiness score in minutes.</p>
                    <div className="flex justify-center gap-4">
                      <button onClick={() => document.getElementById('upload-section')?.scrollIntoView({behavior:'smooth'})} className="px-8 py-4 bg-gradient-to-r from-audit-600 to-audit-500 text-white font-bold rounded-xl shadow-xl shadow-audit-900/40 hover:from-audit-500 hover:to-audit-400 transition transform hover:-translate-y-1 text-lg">Run Free CSRD Scan</button>
                      <button onClick={() => document.getElementById('contact')?.scrollIntoView({behavior:'smooth'})} className="px-8 py-4 bg-slate-800 text-slate-200 border border-slate-700 rounded-xl shadow-sm hover:bg-slate-700 transition transform hover:-translate-y-1 text-lg font-bold">Book a Demo</button>
                    </div>
                    <p className="text-xs text-slate-500 mt-6">Trusted by 500+ SMEs â€¢ Security-first architecture â€¢ GDPR-aware by design</p>
                 </div>
                 <div id="upload-section" className="container mx-auto px-4 pb-20"><UploadSection onAnalyze={handleAnalyze} onDemoLoad={handleDemoLoad} isAnalyzing={false} /></div>
                 <WhySection />
                 <PricingSection />
                 <ContactSection />
              </div>
            )}
            {state === AppState.ANALYZING && <div className="min-h-[60vh] flex flex-col items-center justify-center space-y-6"><div className="w-24 h-24 border-4 border-slate-800 border-t-audit-500 rounded-full animate-spin"></div><h3 className="text-2xl font-bold text-white">Global Standards Engine</h3><p className="text-slate-400">Forensic Audit in progress...</p></div>}
            {state === AppState.ERROR && <div className="container mx-auto px-4 py-16 text-center"><div className="max-w-md mx-auto bg-slate-900 p-8 rounded-2xl shadow-xl border border-red-900/30"><h3 className="text-xl font-bold text-red-500 mb-2">Analysis Failed</h3><p className="text-slate-400 mb-6">{error}</p><button onClick={reset} className="px-6 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700">Try Again</button></div></div>}
            {state === AppState.COMPLETE && report && <div className="container mx-auto px-4 py-8"><ReportView report={report} onReset={reset} apiKey={userKey || PUBLIC_API_KEY} /></div>}
          </main>
          <footer className="py-12 bg-slate-950 border-t border-slate-900 text-center space-y-4">
             <div className="flex justify-center gap-6 text-sm font-medium text-slate-500"><button onClick={() => setLegal({ open: true, type: 'privacy' })} className="hover:text-audit-500">Privacy</button><button onClick={() => setLegal({ open: true, type: 'terms' })} className="hover:text-audit-500">Terms</button></div>
             <p className="text-slate-600 text-xs">Â© 2024 Audit Crystal.</p>
          </footer>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>